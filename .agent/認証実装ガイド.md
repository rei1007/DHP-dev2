# Discord OAuth 認証実装ガイド

## 概要

運営ダッシュボード（admin.html）へのアクセスに Discord 認証を要求する機能を実装しました。

## 認証フロー

1. **運営ダッシュボードリンクをクリック** → `admin.html` にアクセス
2. **認証チェック** → ログインしていない場合は自動的に `login.html` にリダイレクト
3. **Discord でログイン** → Discord OAuth 認証画面へ
4. **認証成功** → `admin.html` (運営ダッシュボード) へリダイレクト
5. **ログアウト** → `login.html` へリダイレクト

## 実装ファイル

### 1. `js/auth.js` (新規作成)

認証機能を管理するモジュール

**主要な関数:**

- `loginWithDiscord()` - Discord OAuth ログインを開始
- `logout()` - ログアウトして login.html にリダイレクト
- `getCurrentUser()` - 現在のユーザーセッションを取得
- `requireAuth()` - 認証が必要なページで使用。未ログインの場合は login.html にリダイレクト

### 2. `login.html` (更新)

従来の ID/Password フォームから、Discord 認証ボタンに変更

**変更内容:**

- Discord ログインボタンの追加
- Discord アイコン付きの洗練された UI デザイン
- Supabase JS Client の読み込み
- `auth.js`モジュールのインポートと Discord ログイン処理

### 3. `js/admin.js` (更新)

ページ読み込み時に認証チェックを実行

**変更内容:**

- `auth.js`モジュールのインポート
- `DOMContentLoaded`イベントで`requireAuth()`を呼び出し
- 認証済みユーザーの Discord ユーザー名を表示
- ログアウト関数を`auth.logout()`を使用するように更新

### 4. `admin.html`

変更なし（既存のログアウトボタンとユーザー表示要素を活用）

## Supabase 設定要件

この機能を有効にするには、Supabase プロジェクトで以下の設定が必要です：

### Discord OAuth 設定手順

1. **Discord Developer Portal でアプリケーションを作成**

   - https://discord.com/developers/applications
   - 「New Application」をクリック
   - アプリケーション名を入力（例: "大学杯運営ダッシュボード"）

2. **OAuth2 設定**

   - 左メニューから「OAuth2」を選択
   - 「Client ID」と「Client Secret」をコピー

3. **リダイレクト URL を追加**

   - Redirects セクションに以下を追加:
     ```
     https://<YOUR_SUPABASE_PROJECT_REF>.supabase.co/auth/v1/callback
     ```

4. **Supabase で認証プロバイダーを設定**

   - Supabase ダッシュボードにログイン
   - Authentication > Providers > Discord を選択
   - 「Discord Enabled」を ON に
   - Discord Client ID と Client Secret を入力
   - 保存

5. **Site URL とリダイレクト URL を設定**
   - Authentication > URL Configuration
   - Site URL: `http://localhost` または本番 URL
   - Redirect URLs に `http://localhost/admin.html` または本番 URL/admin.html を追加

## テスト方法

### ローカル開発環境

1. ローカルサーバーを起動（例: Live Server）
2. ブラウザで `http://localhost/index.html` を開く
3. 「運営ダッシュボード」リンクをクリック
4. `admin.html` → 自動的に `login.html` にリダイレクト
5. 「Discord でログイン」ボタンをクリック
6. Discord 認証画面が表示される
7. 認証後、`admin.html` にリダイレクトされる
8. ユーザー名が右上に表示される
9. サイドバーの「ログアウト」をクリック
10. `login.html` に戻る

### 注意点

- Discord OAuth 認証は `localhost` では動作しない場合があります
- 開発時は ngrok や Vercel などのホスティングサービスを使用することを推奨
- Supabase の設定が完了していない場合、エラーが発生します

## セキュリティ考慮事項

- ✅ フロントエンドでの認証チェック実装済み
- ⚠️ バックエンド（Supabase Row Level Security）での保護も推奨
- ⚠️ Supabase の RLS ポリシーを設定して、認証されたユーザーのみがデータを編集できるようにすること

## 今後の拡張案

- [ ] 特定の Discord サーバーメンバーのみアクセス許可
- [ ] ロール（役割）ベースのアクセス制御
- [ ] セッションタイムアウト設定
- [ ] 2 要素認証（2FA）
