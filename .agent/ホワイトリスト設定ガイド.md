# ホワイトリスト機能 セットアップガイド（シンプル版）

## 概要

運営ダッシュボードへのアクセスを、**Discord ID のみ**で管理するシンプルなホワイトリスト機能です。

## 🔐 セキュリティレベル

### 実装前

- ❌ Discord で認証すれば誰でもアクセス可能
- ❌ データベースを直接操作可能

### 実装後

- ✅ ホワイトリストに登録された Discord ID のみアクセス可能
- ✅ フロントエンドとバックエンド（Supabase RLS）の両方で保護
- ✅ データベースへの直接アクセスもブロック
- ✅ 管理画面から簡単に管理者を追加・削除可能

---

## 📋 セットアップ手順

### ステップ 1: Supabase でテーブルとポリシーを設定

1. **Supabase ダッシュボードにアクセス**

   - https://supabase.com/dashboard にログイン
   - プロジェクトを選択

2. **SQL Editor を開く**

   - 左メニューから「SQL Editor」を選択
   - 「New query」をクリック

3. **SQL スクリプトを実行**

   - `.agent/supabase-whitelist-setup.sql` の内容をコピー
   - SQL Editor に貼り付けて「Run」をクリック

4. **実行結果を確認**
   - エラーがないことを確認
   - 「Table Editor」で `admin_whitelist` テーブルが作成されていることを確認

### ステップ 2: **あなた自身**を初期管理者として登録

#### Discord ID の取得方法

1. **Discord 開発者モードを有効化**

   - Discord 設定（⚙）を開く
   - アプリの設定 > 詳細設定
   - 「開発者モード」を**ON**にする

2. **自分の Discord ID をコピー**
   - Discord のメイン画面で、自分のアイコンを右クリック
   - 「ID をコピー」をクリック

#### Supabase で初期管理者を登録

SQL Editor で以下を実行（**必須**）：

```sql
INSERT INTO admin_whitelist (discord_id, name, notes) VALUES
('あなたのDiscord ID', 'あなたの名前', '初期管理者');
```

**例:**

```sql
INSERT INTO admin_whitelist (discord_id, name, notes) VALUES
('123456789012345678', '山田太郎', '初期管理者 - 最初の登録');
```

### ステップ 3: 動作確認

1. **ブラウザでテスト**

   ```
   http://localhost:5500/admin.html
   ```

2. **期待される動作:**
   - ✅ ホワイトリストに登録したアカウント → 管理画面にアクセス可能
   - ✅ 未登録のアカウント → `unauthorized.html` にリダイレクト
   - ✅ 未ログイン → `login.html` にリダイレクト

---

## 🛠️ 管理者の追加・削除

### 2 人目以降の管理者を追加（管理画面から）

1. 運営ダッシュボードにログイン
2. サイドバーから「ホワイトリスト管理」をクリック
3. 「＋ 管理者を追加」ボタンをクリック
4. 以下の情報を入力：
   - **名前**（必須）
   - **Discord ID**（必須）
   - 役割（管理者 / 運営者）
   - メモ（任意）
5. 「追加」をクリック

**Discord ID の取得（追加したい人の ID）:**

- 追加したい人の Discord アカウントで、開発者モードを有効化してもらう
- その人のアイコンを右クリック > ID をコピー
- その ID を入力

### 管理者を削除

1. ホワイトリスト管理画面で対象の管理者カードを表示
2. 「削除」ボタンをクリック
3. 確認ダイアログで「OK」

### SQL で直接操作（参考）

**管理者を追加:**

```sql
INSERT INTO admin_whitelist (discord_id, name, notes) VALUES
('新しい管理者のDiscord ID', '名前', '追加理由');
```

**管理者を削除:**

```sql
DELETE FROM admin_whitelist WHERE discord_id = '削除する Discord ID';
```

**管理者一覧を表示:**

```sql
SELECT id, name, discord_id, role, added_at, added_by, notes
FROM admin_whitelist
ORDER BY added_at DESC;
```

---

## 🔍 トラブルシューティング

### Q1: ホワイトリストに登録したのにアクセスできない

**確認事項:**

1. Discord ID が正しいか確認

   - 18 桁の数字になっているか
   - ブラウザのコンソールに表示されるログを確認
   - `🔍 Checking whitelist for Discord ID:` の値と、データベースの値が一致するか

2. キャッシュをクリアして再ログイン
   - ログアウト > ブラウザのキャッシュをクリア > 再度ログイン

**デバッグ方法:**

```javascript
// ブラウザのコンソールで実行
import { getCurrentUser } from "./js/auth.js";
const user = await getCurrentUser();
console.log("Discord ID:", user.user_metadata?.provider_id);
```

この値と Supabase の`admin_whitelist`テーブルの`discord_id`が一致するか確認してください。

### Q2: "Table 'admin_whitelist' does not exist" エラー

**解決策:**

- SQL スクリプトが正しく実行されたか確認
- Supabase の「Table Editor」で `admin_whitelist` が存在するか確認
- 再度 `.agent/supabase-whitelist-setup.sql` を実行

### Q3: RLS ポリシーが機能しない

**確認事項:**

1. テーブルで RLS が有効化されているか確認

   ```sql
   SELECT tablename, rowsecurity
   FROM pg_tables
   WHERE tablename IN ('admin_whitelist', 'tournaments', 'news');
   ```

   `rowsecurity`が`true`になっているか確認

2. ポリシーが正しく作成されているか確認
   ```sql
   SELECT schemaname, tablename, policyname
   FROM pg_policies
   WHERE tablename IN ('admin_whitelist', 'tournaments', 'news');
   ```

### Q4: 全員がアクセスできなくなった

**緊急復旧手順:**

1. Supabase ダッシュボード > Table Editor > `admin_whitelist`
2. 「Insert row」で自分を再度追加
   - `discord_id`: あなたの Discord ID
   - `name`: あなたの名前
3. ログアウト > 再度ログイン

---

## 📊 セキュリティチェックリスト

実装後、以下を確認してください：

- [ ] `admin_whitelist` テーブルが作成されている
- [ ] 初期管理者（自分）が登録されている
- [ ] `tournaments` と `news` テーブルで RLS が有効化されている
- [ ] RLS ポリシーが正しく設定されている
- [ ] 登録済みアカウントで管理画面にアクセスできる
- [ ] 未登録アカウントで管理画面にアクセスできない（unauthorized.html にリダイレクト）
- [ ] ブラウザコンソールから直接データ操作ができない（RLS でブロック）
- [ ] 管理画面から他の管理者を追加できる

---

## 🚀 運用のベストプラクティス

1. **定期的な監査**

   - ホワイトリストを定期的に見直す
   - 退任した運営者のアカウントを削除

2. **Discord ID のバックアップ**

   - 重要な管理者の Discord ID をメモしておく
   - 万が一の復旧に備える

3. **最低 2 人の管理者を登録**

   - 1 人しかいないと、そのアカウントが使えなくなった時に困る
   - 信頼できる人を最低もう 1 人登録しておく

4. **役割の使い分け**
   - `admin`: すべての権限
   - `operator`: 運営者（将来的に権限を分ける場合に使用）

---

## 💡 重要な注意事項

### ⚠️ 必ず守ってください

1. **自分自身を削除しないこと**

   - 現在ログイン中のアカウントを削除すると、次回ログイン時にアクセスできなくなります

2. **最低 1 人の管理者を維持**

   - 全員を削除すると誰もアクセスできなくなります
   - 復旧には Supabase ダッシュボードでの直接操作が必要です

3. **Discord ID は間違えないこと**
   - Discord ID は 18 桁の数字です
   - コピー&ペーストで間違えないように確認してください

---

## 📞 サポート

問題が解決しない場合は、以下の情報を添えてお問い合わせください：

- エラーメッセージ
- ブラウザのコンソールログ
- 実行した SQL クエリ
- Discord ID が正しいか（最初の数桁のみで OK）

---

**最終更新:** 2025-12-20  
**バージョン:** 2.0 (Discord ID のみで管理するシンプル版)
