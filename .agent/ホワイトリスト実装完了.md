# ホワイトリスト機能 実装完了

## ✅ 実装内容

Discord 認証をベースとした**ホワイトリストによるアクセス制御機能**を実装しました。

### 主な機能

1. **ホワイトリストテーブル（`admin_whitelist`）**

   - 承認された管理者の Discord ID やメールアドレスを登録
   - 役割（role）の管理
   - 登録日時・登録者の記録

2. **フロントエンドでの認証チェック**

   - `auth.js`の`requireAuth()`関数が自動的にホワイトリストをチェック
   - 未登録ユーザーは`unauthorized.html`にリダイレクト

3. **Supabase RLS によるバックエンド保護**

   - `tournaments`と`news`テーブルへの書き込みを制限
   - ホワイトリストに登録されたユーザーのみがデータを編集可能
   - 開発ツールからの直接操作もブロック

4. **GUI 管理画面**
   - 運営ダッシュボード内でホワイトリストを管理
   - 管理者の追加・削除が可能
   - Discord ID、メールアドレス、役割の管理

---

## 📁 作成・更新されたファイル

### 新規作成

- `.agent/supabase-whitelist-setup.sql` - Supabase 設定用 SQL スクリプト
- `.agent/ホワイトリスト設定ガイド.md` - 詳細なセットアップガイド
- `public/unauthorized.html` - 未承認ユーザー向けページ

### 更新

- `public/js/auth.js` - ホワイトリストチェック機能を追加
- `public/js/common.js` - ホワイトリスト管理関数を追加
- `public/js/admin.js` - ホワイトリスト管理画面を追加
- `public/admin.html` - サイドバーにホワイトリストリンクを追加

---

## 🚀 セットアップ手順（重要！）

### ⚠️ この手順を完了するまでセキュリティは不完全です

1. **Supabase ダッシュボードにアクセス**

   - https://supabase.com/dashboard

2. **SQL Editor で実行**

   - `.agent/supabase-whitelist-setup.sql`の内容をコピー＆実行
   - テーブルと RLS ポリシーが自動的に作成されます

3. **初期管理者を登録**

   ```sql
   INSERT INTO admin_whitelist (discord_id, email, name, notes) VALUES
   ('あなたのDiscord ID', 'あなたのメールアドレス', 'あなたの名前', '初期管理者');
   ```

4. **Discord ID の取得方法**
   - Discord 設定 > アプリの設定 > 詳細設定 > 開発者モードを有効化
   - 自分のアイコンを右クリック > ID をコピー

---

## 🔍 動作確認

### テストケース

1. ✅ **ホワイトリスト登録済みアカウント**

   - `login.html`で Discord ログイン
   - → `admin.html`に正常にアクセス
   - → 大会・お知らせの編集が可能

2. ✅ **未登録アカウント**

   - `login.html`で別の Discord アカウントでログイン
   - → `unauthorized.html`にリダイレクト
   - → 管理画面にアクセス不可

3. ✅ **開発ツールからの直接操作**
   - ブラウザコンソールで Supabase クライアントを使用してデータ操作を試みる
   - → RLS ポリシーによりブロックされる

### 確認コマンド

```javascript
// ブラウザのコンソールで実行
import { getCurrentUser } from "./js/auth.js";
const user = await getCurrentUser();
console.log("Discord ID:", user.user_metadata?.provider_id);
console.log("Email:", user.email);
```

---

## 🔐 セキュリティレベル

### Before（実装前）

- ❌ Discord で認証すれば誰でもアクセス可能
- ❌ フロントエンドのみの認証（バイパス可能）
- ❌ Supabase API キーがあれば直接データ操作可能

### After（実装後）

- ✅ ホワイトリストに登録されたユーザーのみアクセス可能
- ✅ フロントエンドとバックエンド（RLS）の両方で保護
- ✅ 開発ツールからの直接アクセスもブロック
- ✅ GUI で簡単に管理者を追加・削除可能

---

## 📚 詳細ドキュメント

- **`.agent/ホワイトリスト設定ガイド.md`** - 詳細なセットアップ手順とトラブルシューティング
- **`.agent/認証実装ガイド.md`** - Discord 認証の基本実装

---

## 🛠️ 運用方法

### 新しい管理者を追加

1. 運営ダッシュボードにログイン
2. サイドバーから「ホワイトリスト管理」をクリック
3. 「＋ 管理者を追加」ボタンをクリック
4. 以下の情報を入力：
   - 名前（必須）
   - Discord ID または メールアドレス（いずれか必須）
   - 役割（管理者 / 運営者）
   - メモ（任意）
5. 「追加」をクリック

### 管理者を削除

1. ホワイトリスト管理画面で対象の管理者カードを表示
2. 「削除」ボタンをクリック
3. 確認ダイアログで「OK」

---

## ⚠️ 注意事項

1. **自分自身を削除しないこと**

   - 現在ログイン中のアカウントを削除すると、次回ログイン時にアクセスできなくなります

2. **最低 1 人の管理者を維持**

   - 全員を削除すると誰もアクセスできなくなります
   - 復旧には Supabase ダッシュボードでの直接操作が必要です

3. **Discord ID とメールアドレスの両方を登録推奨**
   - どちらか一方でマッチすればアクセス可能
   - メールアドレスは変更される可能性があるため、Discord ID も登録しておくと安全

---

## 🆘 トラブルシューティング

### Q: ホワイトリストに登録したのにアクセスできない

**確認事項:**

1. ブラウザのコンソールログを確認
   - `🔍 Checking whitelist for:` の値を確認
2. Supabase の`admin_whitelist`テーブルを確認
   - Discord ID またはメールアドレスが正しく登録されているか
3. RLS ポリシーが有効化されているか確認

### Q: "Table 'admin_whitelist' does not exist" エラー

**解決策:**

- `.agent/supabase-whitelist-setup.sql`を実行してください

### Q: 全員がアクセスできなくなった

**緊急復旧手順:**

1. Supabase ダッシュボード > Table Editor > `admin_whitelist`
2. 「Insert row」で自分を追加
3. 再度ログインを試行

---

## 📞 サポート

詳細な手順やトラブルシューティングは以下を参照してください：

- `.agent/ホワイトリスト設定ガイド.md`

実装完了日: 2025-12-20
