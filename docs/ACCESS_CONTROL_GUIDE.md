# 🔒 アクセス制限機能 - クイックガイド

## 🎯 実装済み機能

運営ロール（`admin`）を持つアカウントのみが以下の操作を実行できます：

- ✅ 運営ダッシュボード（`admin.html`）へのアクセス
- ✅ 大会情報の作成・編集・削除
- ✅ お知らせの作成・編集・削除
- ✅ アカウント管理（ロール変更、削除）

## 🚀 セットアップ（初回のみ）

### 1. SQL ポリシーを適用

Supabase 管理画面の SQL Editor で以下のファイルを実行：

```
sql/apply_admin_only_policies.sql
```

### 2. 最初の管理者を設定

Supabase 管理画面の SQL Editor で実行：

```sql
-- 自分のメールアドレスを管理者に設定
UPDATE users SET role = 'admin'
WHERE email = 'あなたのメールアドレス@example.com';
```

### 3. 動作確認

1. ログアウト
2. 再度ログイン
3. 運営ダッシュボードにアクセスできることを確認

## 📋 ロールの種類

| ロール    | 説明                 | ダッシュボード  | 書き込み |
| --------- | -------------------- | --------------- | -------- |
| `pending` | 未承認（デフォルト） | ❌ アクセス不可 | ❌ 不可  |
| `admin`   | 運営                 | ✅ アクセス可能 | ✅ 可能  |

## 👥 新しい運営メンバーの追加

1. 新メンバーがログインすると自動的に`pending`で登録される
2. 既存の管理者が「アカウント管理」タブを開く
3. 該当ユーザーのロールボタン（未承認）をクリック
4. ロールが「運営」に変更される
5. 新メンバーがログインし直すと、ダッシュボードにアクセス可能

## 🛡️ セキュリティの仕組み

### 2 層のセキュリティ

1. **アプリケーションレベル** (`auth.js`)

   - ログイン時にロールをチェック
   - `admin`以外は`index.html`にリダイレクト

2. **データベースレベル** (Supabase RLS)
   - `admin`以外は書き込み不可
   - API を直接叩いても防御

## ❓ トラブルシューティング

### Q: admin なのにアクセスできない

**A:** ブラウザのコンソール（F12）で以下を確認：

- `🔒 User role: admin` が表示されているか
- エラーメッセージがないか

ロールが`pending`の場合：

```sql
UPDATE users SET role = 'admin' WHERE email = 'your-email@example.com';
```

### Q: 大会やお知らせが作成できない

**A:** 以下を確認：

1. ロールが`admin`になっているか
2. `apply_admin_only_policies.sql`を実行したか

### Q: 既存のユーザーがログインできなくなった

**A:** 正常な動作です。以下の手順で解決：

1. 管理者アカウントでログイン
2. 「アカウント管理」を開く
3. 該当ユーザーのロールを「運営」に変更

## 📚 詳細ドキュメント

より詳しい情報は以下を参照してください：

- **実装の詳細**: `docs/admin-access-control.md`
- **アカウント管理**: `docs/account-management.md`
- **トラブルシューティング**: `docs/troubleshooting-user-registration.md`

## ⚠️ 重要な注意事項

1. **最初の管理者は手動で設定する必要があります**

   - SQL Editor で自分のメールアドレスを`admin`に変更

2. **pending ユーザーはダッシュボードにアクセスできません**

   - 意図的な仕様です
   - 管理者がロールを変更する必要があります

3. **ロール変更は即座に反映されます**

   - ただし、ユーザーは再ログインが必要

4. **公開ページ（index.html）は誰でもアクセス可能**
   - 大会やお知らせの閲覧は制限なし
   - 書き込みのみ制限
